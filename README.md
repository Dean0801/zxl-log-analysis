# 日志分析工具使用文档

## 📋 目录

- [简介](#简介)
- [快速开始](#快速开始)
- [功能特性](#功能特性)
- [使用指南](#使用指南)
- [数据格式说明](#数据格式说明)
- [常见问题](#常见问题)

---

## 简介

日志分析工具是一个基于浏览器的日志分析工具，支持两种数据源：
- **小程序日志**：分析 Grafana 导出的 JSON 日志数据
- **神策日志**：分析神策导出的 Excel 数据

工具提供了筛选、搜索、排序和详情查看功能，帮助开发者和运营人员快速排查问题。

### 主要特点

- ✅ **纯浏览器运行**：无需安装，直接在浏览器中使用
- ✅ **离线处理**：数据完全在本地处理，保护隐私安全
- ✅ **双数据源支持**：支持小程序 JSON 和神策 Excel 两种格式
- ✅ **智能解析**：自动识别事件类型、分类和错误信息
- ✅ **多维度筛选**：支持事件、分类、级别、关键词搜索
- ✅ **错误标识**：自动识别并高亮显示错误状态码和错误消息
- ✅ **会话颜色编码**：根据 sessionId 为错误记录分配颜色，便于区分不同会话
- ✅ **详情查看**：树形结构展示 API 请求详情
- ✅ **多种导入方式**：支持文件上传、剪贴板导入、文本导入三种方式（小程序）
- ✅ **查询日志功能**：支持在 Grafana 中查询日志（小程序）
- ✅ **数据导出**：支持导出筛选结果为 Excel 格式（神策）

---

## 快速开始

### 1. 选择数据源

工具提供两个独立的数据源页面：

- **小程序日志分析**（`index.html`）：默认页面，用于分析 Grafana 导出的 JSON 文件
- **神策日志分析**（`sensors.html`）：用于分析神策导出的 Excel 文件

可以通过页面顶部的导航按钮在两个数据源之间切换。

### 2. 导入日志数据

#### 小程序日志（JSON 格式）

工具提供三种导入方式：

**方式一：文件上传**
1. 点击上传区域或拖拽 JSON 文件到上传区域
2. 支持的文件格式：`.json`（Grafana 导出的日志文件）
3. 文件上传后会自动解析并显示数据

**方式二：剪贴板导入**
1. 复制 JSON 数据到剪贴板
2. 点击"📋 导入剪贴板"按钮
3. 系统会自动读取剪贴板内容并解析

**方式三：文本导入**
1. 点击"📝 导入文本"按钮
2. 在弹出的文本编辑框中输入或粘贴 JSON 数据
3. 点击"确定"按钮完成导入

**方式四：查询日志**
1. 点击"🔍 查询日志"按钮
2. 在弹窗中输入包含项（关键词）和发生时间
3. 点击"查询"按钮，系统会在新窗口中打开 Grafana 查询页面
4. 支持自动解析和格式化时间，可以粘贴各种时间格式

**注意事项**：
- 剪贴板导入和文本导入支持单个 JSON 对象或数组格式
- 单个对象会自动包装成数组进行处理
- 所有导入方式都会将新数据合并到现有数据中
- 查询日志功能会自动将时间范围设置为前后30分钟

#### 神策日志（Excel 格式）
1. 点击"转到神策日志分析"按钮切换到神策页面
2. 点击上传区域或拖拽 Excel 文件到上传区域
3. 支持的文件格式：`.xlsx`、`.xls`（神策导出的 Excel 文件）
4. 文件上传后会自动解析并显示数据

### 3. 查看和分析

- 使用筛选器过滤数据
- 点击"查看详情"查看完整信息
- 使用搜索框快速查找
- 小程序页面：可以导入其他文件合并分析
- 神策页面：可以导出筛选结果为 Excel 格式

---

## 功能特性

### 📤 文件上传

#### 小程序日志（JSON 格式）
- **支持格式**：JSON 文件（Grafana 导出格式）
- **上传方式**：
  - 点击上传区域选择文件
  - 拖拽文件到上传区域
- **文件要求**：
  - 文件必须包含 `line` 字段（可解析为 JSON）
  - 文件必须包含 `timestamp` 字段（时间戳）

#### 神策日志（Excel 格式）
- **支持格式**：Excel 文件（`.xlsx`、`.xls`）
- **上传方式**：
  - 点击上传区域选择文件
  - 拖拽文件到上传区域
- **文件要求**：
  - 文件必须包含 `event`、`time`、`user`、`page` 等列
  - 文件必须包含事件属性列

### 🔍 多维度筛选

#### 事件筛选
- 下拉选择框显示所有可用的事件名称
- 选择特定事件后，只显示该事件的日志记录
- 选择"全部事件"显示所有记录

#### 分类筛选
支持以下分类：
- **自动事件** (auto)：系统自动采集的事件
- **自定义事件** (custom)：用户自定义的事件
- **支付事件** (pay)：支付相关事件
- **渠道事件** (channel)：渠道相关事件
- **阅读事件** (read)：阅读相关事件
- **搜索事件** (search)：搜索相关事件
- **广告事件** (ad)：广告相关事件
- **API事件** (api)：API 调用事件
- **系统事件** (system)：系统级事件

#### 级别筛选
- **INFO**：信息级别日志
- **WARN**：警告级别日志
- **ERROR**：错误级别日志

#### 关键词搜索
- 在搜索框中输入关键词
- 支持搜索事件名称、事件描述、页面路径等内容
- 实时搜索，输入即显示结果

### 📊 排序功能

小程序日志支持以下排序方式：
- **时间倒序**：最新数据在前，按索引降序排列
- **时间正序**（默认）：最旧数据在前，按索引升序排列
- **按上报时间排序**：根据 `calibratedTime` 字段按时间正序排列，缺少该字段的记录会排在最后

**排序特性**：
- 排序范围：仅对当前筛选结果进行排序
- 切换排序时自动重置到第 1 页
- 排序会保留所有筛选条件

### 📄 分页显示

- **每页显示**：50 条记录（可调整）
- **分页导航**：显示当前页码和总页数
- **快速跳转**：点击页码快速跳转到指定页面

### 🏷️ 错误标签显示

工具会自动识别并显示以下错误信息：

#### 错误状态码标签
- 当 API 响应状态码为 400-599 时，显示红色状态码标签
- 标签显示格式：`400`、`401`、`500` 等

#### 错误消息标签
- 当存在错误消息时，显示橙色消息标签
- 支持显示 `[response]` 中的 `message` 字段
- 支持显示 `[error]` 中的错误信息
- 标签内容过长时会截断显示，鼠标悬浮时显示完整内容

#### 会话颜色编码
- 错误索引标签会根据 `sessionId` 自动分配颜色
- 相同 `sessionId` 的记录使用相同颜色，便于识别同一会话的日志
- 支持多种颜色循环分配，当会话数量超过颜色列表时自动循环使用
- 鼠标悬浮在标签上可查看完整的 `sessionId`

### 📋 详情查看

点击"查看详情"按钮可以查看完整的日志信息：

#### 详情弹窗包含：

1. **事件基本信息**
   - 事件名称
   - 事件描述

2. **API 请求详情（树形结构）**
   - **[method]**：请求方法、URL、参数等
   - **[response]**：响应状态码、响应头、响应数据等（如果存在）
   - **[error]**：错误信息（如果存在）
   - 支持折叠/展开查看详细内容
   - 支持复制整个数据部分

3. **事件属性**
   - 用户信息（用户ID、用户IP等）
   - 设备信息（操作系统、浏览器等）
   - 业务信息（书籍ID、章节ID等）
   - 其他自定义属性

#### 树形结构特性

- **层级显示**：清晰的父子节点关系
- **折叠展开**：点击节点展开/折叠子节点
- **视觉连接线**：使用连接线显示层级关系
- **深度缩进**：不同深度的节点有不同的缩进
- **背景色区分**：不同深度使用不同的背景色

### 📥 数据导入与导出

#### 小程序日志 - 多种导入方式

工具提供四种导入方式，方便不同场景下的数据导入：

**1. 文件上传导入**
- **导入功能**：支持导入多个 JSON 文件合并分析
- **导入方式**：点击上传区域选择文件，或点击"📥 导入其他文件"按钮选择文件
- **支持格式**：`.json`（Grafana 导出的日志文件）
- **使用场景**：从文件系统导入日志数据

**2. 剪贴板导入**
- **导入功能**：直接从剪贴板读取 JSON 数据
- **导入方式**：复制 JSON 数据后，点击"📋 导入剪贴板"按钮
- **支持格式**：单个 JSON 对象或数组
- **使用场景**：从其他工具（如 API 响应、文档等）复制数据快速导入
- **注意事项**：需要在 HTTPS 或 localhost 环境下使用（浏览器安全策略要求）

**3. 文本导入**
- **导入功能**：通过文本编辑框输入或粘贴 JSON 数据
- **导入方式**：点击"📝 导入文本"按钮，在弹窗中输入或粘贴数据，点击"确定"
- **支持格式**：单个 JSON 对象或数组
- **使用场景**：需要手动编辑或从多个来源组合数据时使用
- **优势**：可以在导入前编辑和验证数据

**4. 查询日志**
- **查询功能**：在 Grafana 中查询日志数据
- **使用方式**：点击"🔍 查询日志"按钮，输入关键词和时间，点击"查询"
- **支持格式**：
  - 包含项：任意关键词字符串
  - 发生时间：支持 `YYYY-MM-DD HH:mm:ss` 格式，也支持粘贴其他时间格式（会自动解析）
- **使用场景**：需要从 Grafana 查询更多相关日志时使用
- **特性**：
  - 自动将时间范围设置为前后30分钟
  - 支持时间格式自动解析和格式化
  - 在新窗口中打开 Grafana 查询页面
  - 可以连续查询，不会自动关闭弹窗

**合并规则**（适用于文件、剪贴板、文本导入方式）：
- 新导入的数据会追加到现有数据中
- 序号会自动递增，保持连续性
- 会话颜色映射会保留，新会话会分配新颜色
- 单个 JSON 对象会自动包装成数组格式

#### 神策日志 - 数据导出
- **导出格式**：Excel（`.xlsx`）
- **导出内容**：当前筛选和分页后的数据
- **导出字段**：
  - 事件名称、时间、用户信息
  - 页面路径、事件属性
  - 其他业务字段

---

## 使用指南

### 场景一：排查 API 错误

1. **上传日志文件**
   - 上传包含错误信息的日志文件

2. **筛选错误记录**
   - 在"级别筛选"中选择"ERROR"
   - 或使用搜索框搜索错误关键词

3. **查看错误标签**
   - 在事件描述列中查看错误状态码和错误消息标签
   - 红色标签显示状态码（如 `400`）
   - 橙色标签显示错误消息（如"参数校验失败"）

4. **查看详细信息**
   - 点击"查看详情"按钮
   - 在弹窗中查看完整的 API 请求和响应信息
   - 使用树形结构查看嵌套的数据结构

### 场景二：分析特定事件

1. **选择事件类型**
   - 在"事件筛选"下拉框中选择要分析的事件
   - 例如：选择"客户端日志上报"

2. **进一步筛选**
   - 使用分类筛选缩小范围
   - 使用级别筛选查看特定级别的日志
   - 使用搜索框搜索特定关键词

3. **查看趋势**
   - 使用排序功能查看时间顺序
   - 使用分页浏览历史记录

### 场景三：在 Grafana 中查询日志（小程序）

当需要查询更多相关日志时，可以使用查询日志功能：

1. **打开查询弹窗**
   - 点击"🔍 查询日志"按钮
   - 弹窗会自动填充当前时间作为默认值

2. **输入查询条件**
   - **包含项**：输入要查询的关键词（如用户ID、订单号、错误信息等）
   - **发生时间**：输入或粘贴时间，支持多种格式：
     - `YYYY-MM-DD HH:mm:ss`（标准格式）
     - 粘贴其他格式的时间字符串（会自动解析）

3. **执行查询**
   - 点击"查询"按钮
   - 系统会在新窗口中打开 Grafana 查询页面
   - 查询时间范围自动设置为输入时间的前后30分钟

4. **连续查询**
   - 查询后弹窗不会自动关闭，可以继续输入其他条件查询
   - 点击"取消"或关闭按钮可以关闭弹窗

### 场景四：合并多个日志数据（小程序）

工具支持多种方式合并数据，可以灵活组合使用：

**方式一：文件合并**
1. **上传第一个文件**
   - 上传包含日志数据的 JSON 文件
   - 确认数据解析成功

2. **导入其他文件**
   - 点击"📥 导入其他文件"按钮
   - 选择或拖拽其他 JSON 文件
   - 数据会自动合并到现有数据中

**方式二：剪贴板快速导入**
1. **准备数据**
   - 从 API 响应、文档或其他工具复制 JSON 数据

2. **快速导入**
   - 点击"📋 导入剪贴板"按钮
   - 系统自动读取并解析剪贴板内容
   - 数据自动合并到现有数据中

**方式三：文本编辑导入**
1. **打开文本编辑器**
   - 点击"📝 导入文本"按钮

2. **输入或编辑数据**
   - 在文本编辑框中输入或粘贴 JSON 数据
   - 可以手动编辑和验证数据格式

3. **完成导入**
   - 点击"确定"按钮
   - 数据会自动合并到现有数据中

**统一分析**
- 使用筛选器对所有合并的数据进行筛选
- 通过会话颜色编码识别不同会话的记录
- 使用排序功能按时间顺序查看

### 场景五：导出分析结果（神策）

1. **应用筛选条件**
   - 设置事件、分类等筛选条件
   - 使用搜索框进一步过滤

2. **导出数据**
   - 点击"📥 导出筛选结果"按钮
   - 下载 Excel 文件

3. **后续分析**
   - 使用 Excel 或其他数据分析工具打开导出的文件
   - 进行进一步的数据分析

---

## 数据格式说明

### 小程序日志格式（JSON）

工具支持 Grafana 导出的 JSON 格式，文件结构如下：

```json
[
  {
    "line": "{\"time\":\"2025-12-16T14:14:47.598899666+08:00\",\"level\":\"ERROR\",\"msg\":\"客户端日志上报\",...}",
    "timestamp": "1765865687753000000"
  },
  ...
]
```

#### 关键字段说明

- **line**：日志内容（JSON 字符串，需要解析）
- **timestamp**：时间戳（纳秒级）

#### line 字段内容说明

解析后的 `line` 字段包含以下信息：

- **time**：日志时间
- **level**：日志级别（INFO/WARN/ERROR）
- **msg**：日志消息
- **event**：事件名称
- **analysisData**：分析数据
  - **fail_reason**：失败原因（可能包含 `[method]`、`[response]`、`[error]` 部分）
  - **calibratedTime**：上报时间（用于按上报时间排序）
  - **sessionId**：会话ID（用于颜色编码）
- **userAttributes**：用户属性
- **其他业务字段**

#### fail_reason 格式说明

`fail_reason` 字段可能包含以下部分：

```
[method]:
 {"baseURL":"...","url":"...","type":"GET",...}

[response]:
 {"statusCode":400,"data":{"code":400,"message":"参数校验失败"},...}

[error]:
 request:fail response data error
```

### 神策日志格式（Excel）

工具支持神策导出的 Excel 格式，文件应包含以下列：

- **event**：事件名称
- **time**：事件时间
- **user**：用户信息
- **page**：页面信息
- **其他属性列**：事件相关的自定义属性

文件格式要求：
- 支持 `.xlsx` 和 `.xls` 格式
- 第一行为列标题
- 每行为一条事件记录

---

## 常见问题

### Q1: 为什么必须通过 HTTP 协议访问？

A: 由于使用了 ES Module 和 FileReader API，浏览器安全策略要求必须通过 HTTP/HTTPS 协议访问。直接双击打开文件（file:// 协议）会导致模块加载失败。

**解决方案**：
```bash
# 使用 Python
python3 -m http.server 8080

# 使用 Node.js
npx http-server -p 8080
```

### Q2: 上传文件后没有显示数据？

A: 请检查以下几点：
1. 文件格式是否正确（必须是 JSON 格式）
2. 文件是否包含 `line` 字段
3. 文件是否包含 `timestamp` 字段
4. 打开浏览器控制台查看是否有错误信息

### Q3: 如何查看完整的错误信息？

A: 有两种方式：
1. **快速查看**：在事件描述列中查看错误标签（状态码和消息）
2. **详细查看**：点击"查看详情"按钮，在弹窗中查看完整的 API 请求和响应信息

### Q4: 如何合并多个日志数据？

A: 小程序日志页面支持三种导入方式，可以灵活组合使用：

**文件导入**：
1. 先上传第一个 JSON 文件
2. 点击"📥 导入其他文件"按钮
3. 选择或拖拽其他 JSON 文件
4. 数据会自动合并，序号会连续递增

**剪贴板导入**：
1. 复制 JSON 数据到剪贴板
2. 点击"📋 导入剪贴板"按钮
3. 系统自动读取并合并数据

**文本导入**：
1. 点击"📝 导入文本"按钮
2. 在文本编辑框中输入或粘贴 JSON 数据
3. 点击"确定"完成导入

**合并特性**：
- 所有导入方式都会将新数据合并到现有数据中
- 序号会自动递增，保持连续性
- 可以通过会话颜色编码区分不同会话的记录
- 支持单个 JSON 对象或数组格式

### Q5: 导出的 Excel 文件如何使用？

A: 神策日志页面导出的 Excel 文件可以使用以下工具打开：
- **Excel**：直接打开进行数据分析
- **数据分析工具**：使用 Python、R 等工具进行进一步分析

### Q6: 如何筛选特定时间段的日志？

A: 当前版本暂不支持时间范围筛选，但可以通过以下方式：
1. 使用排序功能按时间排序（包括按上报时间排序）
2. 使用分页功能浏览不同页面的数据
3. 使用搜索框搜索特定时间关键词

### Q7: 错误标签没有显示？

A: 请确认：
1. 日志中是否包含 `fail_reason` 字段
2. `fail_reason` 中是否包含 `[response]` 或 `[error]` 部分
3. `[response]` 中的状态码是否为 400-599
4. 是否有错误消息内容

### Q8: 会话颜色编码如何工作？

A: 会话颜色编码功能说明：
1. 系统会根据每条记录的 `sessionId` 自动分配颜色
2. 相同 `sessionId` 的记录使用相同颜色，便于识别同一会话
3. 当会话数量超过预设颜色数量时，会循环使用颜色列表
4. 鼠标悬浮在错误索引标签上可查看完整的 `sessionId`

### Q9: 树形结构中的节点无法展开？

A: 请确认：
1. 节点是否有子节点（空对象或数组不会显示展开图标）
2. 浏览器控制台是否有 JavaScript 错误
3. 尝试刷新页面重新加载数据

### Q10: 如何切换数据源？

A: 可以通过以下方式切换：
1. **小程序日志**：访问 `index.html` 或点击页面上的"转到神策日志分析"按钮
2. **神策日志**：访问 `sensors.html` 或点击页面上的"转到小程序日志分析"按钮
3. 两个页面相互独立，数据不会共享

### Q11: 剪贴板导入功能无法使用？

A: 剪贴板导入功能需要浏览器支持 Clipboard API，并且必须在安全上下文（HTTPS 或 localhost）中使用。如果无法使用，可以：
1. 确保通过 HTTP 服务器访问（如 `http://localhost:8080`）
2. 使用文本导入功能作为替代方案
3. 检查浏览器是否支持 Clipboard API（现代浏览器通常都支持）

### Q12: 文本导入和剪贴板导入有什么区别？

A: 两者的主要区别：
1. **剪贴板导入**：直接从剪贴板读取数据，无需手动输入，适合快速导入
2. **文本导入**：通过文本编辑框输入或粘贴数据，可以在导入前编辑和验证数据
3. **使用场景**：剪贴板导入适合快速导入，文本导入适合需要编辑的场景
4. **格式支持**：两者都支持单个 JSON 对象或数组格式

### Q13: 查询日志功能如何使用？

A: 查询日志功能使用说明：
1. **打开功能**：点击"🔍 查询日志"按钮
2. **输入条件**：
   - 包含项：输入要查询的关键词
   - 发生时间：输入或粘贴时间（支持多种格式，会自动解析）
3. **执行查询**：点击"查询"按钮，系统会在新窗口打开 Grafana 查询页面
4. **时间范围**：查询时间范围自动设置为输入时间的前后30分钟
5. **连续查询**：查询后弹窗不会自动关闭，可以继续查询其他条件

### Q14: 查询日志功能支持哪些时间格式？

A: 查询日志功能支持以下时间格式：
1. **标准格式**：`YYYY-MM-DD HH:mm:ss`（如：2026-02-05 14:30:00）
2. **ISO 格式**：`YYYY-MM-DDTHH:mm:ss`（如：2026-02-05T14:30:00）
3. **其他格式**：支持粘贴各种常见时间格式，系统会自动解析并格式化为标准格式

---

## 技术支持

如有问题或建议，请查看项目代码或联系开发团队。

---

## 更新日志

### v2.3.0
- ✅ 新增查询日志功能，支持在 Grafana 中查询日志
- ✅ 查询日志支持时间格式自动解析和格式化
- ✅ 查询日志自动设置时间范围为前后30分钟

### v2.2.2
- ✅ 修改默认排序为上报时间排序
- ✅ 上报时间兼容接口请求时间

### v2.2.1
- ✅ 增加按上报时间排列筛选和原始时间同时排序的能力
- ✅ 在原始时间下方显示上报时间

### v2.2.0
- ✅ 支持导入文本
- ✅ 支持导入剪贴板

### v2.1.0
- ✅ 支持导入多数据源同时比较

### v2.0.0
- ✅ 双数据源支持（小程序 JSON + 神策 Excel）
- ✅ 数据源页面分离，独立优化
- ✅ 小程序日志导入功能（合并多个文件）
- ✅ 神策日志导出功能（Excel 格式）
- ✅ 按上报时间排序功能
- ✅ 会话颜色编码功能（基于 sessionId）
- ✅ 默认排序改为正序
- ✅ 错误索引标签颜色区分

### v1.0.0
- ✅ 基础日志解析和显示功能
- ✅ 多维度筛选功能
- ✅ 排序和分页功能
- ✅ 错误标签显示功能
- ✅ 详情弹窗和树形结构显示

---

**最后更新**：2026-02-05

