# 小程序日志分析工具使用文档

## 📋 目录

- [简介](#简介)
- [快速开始](#快速开始)
- [功能特性](#功能特性)
- [使用指南](#使用指南)
- [数据格式说明](#数据格式说明)
- [常见问题](#常见问题)

---

## 简介

小程序日志分析工具是一个基于浏览器的日志分析工具，专门用于分析Grafana导出的 JSON 日志数据。工具提供了筛选、搜索、排序和详情查看功能，帮助开发者和运营人员快速排查问题。

### 主要特点

- ✅ **纯浏览器运行**：无需安装，直接在浏览器中使用
- ✅ **离线处理**：数据完全在本地处理，保护隐私安全
- ✅ **智能解析**：自动识别事件类型、分类和错误信息
- ✅ **多维度筛选**：支持事件、分类、级别、关键词搜索
- ✅ **错误标识**：自动识别并高亮显示错误状态码和错误消息
- ✅ **详情查看**：树形结构展示 API 请求详情
- ✅ **数据导出**：支持导出筛选结果为 JSON 格式

---

## 快速开始

### 1. 打开工具

在浏览器中打开 `index.html` 文件（**注意：必须通过 HTTP 协议访问，不能直接双击打开**）

推荐使用本地服务器：
```bash
# 使用 Python
python3 -m http.server 8080

# 使用 Node.js
npx http-server -p 8080

# 然后访问 http://localhost:8080
```

### 2. 上传日志文件

1. 点击上传区域或拖拽 JSON 文件到上传区域
2. 支持的文件格式：`.json`（Grafana 导出的日志文件）
3. 文件上传后会自动解析并显示数据

### 3. 查看和分析

- 使用筛选器过滤数据
- 点击"查看详情"查看完整信息
- 使用搜索框快速查找
- 导出筛选结果进行分析

---

## 功能特性

### 📤 文件上传

- **支持格式**：JSON 文件（Grafana 导出格式）
- **上传方式**：
  - 点击上传区域选择文件
  - 拖拽文件到上传区域
- **文件要求**：
  - 文件必须包含 `line` 字段（可解析为 JSON）
  - 文件必须包含 `timestamp` 字段（时间戳）

### 🔍 多维度筛选

#### 事件筛选
- 下拉选择框显示所有可用的事件名称
- 选择特定事件后，只显示该事件的日志记录
- 选择"全部事件"显示所有记录

#### 分类筛选
支持以下分类：
- **自动事件** (auto)：系统自动采集的事件
- **自定义事件** (custom)：用户自定义的事件
- **支付事件** (pay)：支付相关事件
- **渠道事件** (channel)：渠道相关事件
- **阅读事件** (read)：阅读相关事件
- **搜索事件** (search)：搜索相关事件
- **广告事件** (ad)：广告相关事件
- **API事件** (api)：API 调用事件
- **系统事件** (system)：系统级事件

#### 级别筛选
- **INFO**：信息级别日志
- **WARN**：警告级别日志
- **ERROR**：错误级别日志

#### 关键词搜索
- 在搜索框中输入关键词
- 支持搜索事件名称、事件描述、页面路径等内容
- 实时搜索，输入即显示结果

### 📊 排序功能

- **排序方式**：
  - **倒序**（默认）：最新数据在前，按索引降序排列
  - **正序**：最旧数据在前，按索引升序排列
- **排序范围**：仅对当前筛选结果进行排序

### 📄 分页显示

- **每页显示**：50 条记录（可调整）
- **分页导航**：显示当前页码和总页数
- **快速跳转**：点击页码快速跳转到指定页面

### 🏷️ 错误标签显示

工具会自动识别并显示以下错误信息：

#### 错误状态码标签
- 当 API 响应状态码为 400-599 时，显示红色状态码标签
- 标签显示格式：`400`、`401`、`500` 等

#### 错误消息标签
- 当存在错误消息时，显示橙色消息标签
- 支持显示 `[response]` 中的 `message` 字段
- 支持显示 `[error]` 中的错误信息
- 标签内容过长时会截断显示，鼠标悬浮时显示完整内容

### 📋 详情查看

点击"查看详情"按钮可以查看完整的日志信息：

#### 详情弹窗包含：

1. **事件基本信息**
   - 事件名称
   - 事件描述
   - 数据源标识（小程序埋点）

2. **API 请求详情（树形结构）**
   - **[method]**：请求方法、URL、参数等
   - **[response]**：响应状态码、响应头、响应数据等（如果存在）
   - **[error]**：错误信息（如果存在）
   - 支持折叠/展开查看详细内容
   - 支持复制整个数据部分

3. **事件属性**
   - 用户信息（用户ID、用户IP等）
   - 设备信息（操作系统、浏览器等）
   - 业务信息（书籍ID、章节ID等）
   - 其他自定义属性

#### 树形结构特性

- **层级显示**：清晰的父子节点关系
- **折叠展开**：点击节点展开/折叠子节点
- **视觉连接线**：使用连接线显示层级关系
- **深度缩进**：不同深度的节点有不同的缩进
- **背景色区分**：不同深度使用不同的背景色

### 📥 数据导出

- **导出格式**：JSON
- **导出内容**：当前筛选和分页后的数据
- **导出字段**：
  - 索引、时间、事件名称
  - 事件描述、分类、页面路径
  - 属性信息

---

## 使用指南

### 场景一：排查 API 错误

1. **上传日志文件**
   - 上传包含错误信息的日志文件

2. **筛选错误记录**
   - 在"级别筛选"中选择"ERROR"
   - 或使用搜索框搜索错误关键词

3. **查看错误标签**
   - 在事件描述列中查看错误状态码和错误消息标签
   - 红色标签显示状态码（如 `400`）
   - 橙色标签显示错误消息（如"参数校验失败"）

4. **查看详细信息**
   - 点击"查看详情"按钮
   - 在弹窗中查看完整的 API 请求和响应信息
   - 使用树形结构查看嵌套的数据结构

### 场景二：分析特定事件

1. **选择事件类型**
   - 在"事件筛选"下拉框中选择要分析的事件
   - 例如：选择"客户端日志上报"

2. **进一步筛选**
   - 使用分类筛选缩小范围
   - 使用级别筛选查看特定级别的日志
   - 使用搜索框搜索特定关键词

3. **查看趋势**
   - 使用排序功能查看时间顺序
   - 使用分页浏览历史记录

### 场景三：导出分析结果

1. **应用筛选条件**
   - 设置事件、分类、级别等筛选条件
   - 使用搜索框进一步过滤

2. **导出数据**
   - 点击"📥 导出筛选结果"按钮
   - 下载 JSON 文件

3. **后续分析**
   - 使用其他工具（如 Excel、数据分析工具）打开导出的 JSON 文件
   - 进行进一步的数据分析

---

## 数据格式说明

### 输入格式

工具支持 Grafana 导出的 JSON 格式，文件结构如下：

```json
[
  {
    "line": "{\"time\":\"2025-12-16T14:14:47.598899666+08:00\",\"level\":\"ERROR\",\"msg\":\"客户端日志上报\",...}",
    "timestamp": "1765865687753000000"
  },
  ...
]
```

### 关键字段说明

- **line**：日志内容（JSON 字符串，需要解析）
- **timestamp**：时间戳（纳秒级）

### line 字段内容说明

解析后的 `line` 字段包含以下信息：

- **time**：日志时间
- **level**：日志级别（INFO/WARN/ERROR）
- **msg**：日志消息
- **event**：事件名称
- **analysisData**：分析数据
  - **fail_reason**：失败原因（可能包含 `[method]`、`[response]`、`[error]` 部分）
- **userAttributes**：用户属性
- **其他业务字段**

### fail_reason 格式说明

`fail_reason` 字段可能包含以下部分：

```
[method]:
 {"baseURL":"...","url":"...","type":"GET",...}

[response]:
 {"statusCode":400,"data":{"code":400,"message":"参数校验失败"},...}

[error]:
 request:fail response data error
```

---

## 常见问题

### Q1: 为什么必须通过 HTTP 协议访问？

A: 由于使用了 ES Module 和 FileReader API，浏览器安全策略要求必须通过 HTTP/HTTPS 协议访问。直接双击打开文件（file:// 协议）会导致模块加载失败。

**解决方案**：
```bash
# 使用 Python
python3 -m http.server 8080

# 使用 Node.js
npx http-server -p 8080
```

### Q2: 上传文件后没有显示数据？

A: 请检查以下几点：
1. 文件格式是否正确（必须是 JSON 格式）
2. 文件是否包含 `line` 字段
3. 文件是否包含 `timestamp` 字段
4. 打开浏览器控制台查看是否有错误信息

### Q3: 如何查看完整的错误信息？

A: 有两种方式：
1. **快速查看**：在事件描述列中查看错误标签（状态码和消息）
2. **详细查看**：点击"查看详情"按钮，在弹窗中查看完整的 API 请求和响应信息

### Q4: 导出的 JSON 文件如何使用？

A: 导出的 JSON 文件可以使用以下工具打开：
- **文本编辑器**：查看原始 JSON 数据
- **Excel**：导入 JSON 数据进行分析
- **数据分析工具**：使用 Python、R 等工具进行进一步分析

### Q5: 如何筛选特定时间段的日志？

A: 当前版本暂不支持时间范围筛选，但可以通过以下方式：
1. 使用排序功能按时间排序
2. 使用分页功能浏览不同页面的数据
3. 使用搜索框搜索特定时间关键词

### Q6: 错误标签没有显示？

A: 请确认：
1. 日志中是否包含 `fail_reason` 字段
2. `fail_reason` 中是否包含 `[response]` 或 `[error]` 部分
3. `[response]` 中的状态码是否为 400-599
4. 是否有错误消息内容

### Q7: 树形结构中的节点无法展开？

A: 请确认：
1. 节点是否有子节点（空对象或数组不会显示展开图标）
2. 浏览器控制台是否有 JavaScript 错误
3. 尝试刷新页面重新加载数据

---

## 技术支持

如有问题或建议，请查看项目代码或联系开发团队。

---

## 更新日志

### v1.0.0
- ✅ 基础日志解析和显示功能
- ✅ 多维度筛选功能
- ✅ 排序和分页功能
- ✅ 错误标签显示功能
- ✅ 详情弹窗和树形结构显示
- ✅ 数据导出功能

---

**最后更新**：2025-12-18

